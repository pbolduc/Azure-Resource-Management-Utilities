# Azure Sql Database Scaling
A set of helper classes that can be used to scale an Azure SQL Database Up or Down.

The goal is to be easily configure auto-scaling of your Azure SQL Database based on the load.
It is intended to used with dev/test/MSDN credit accounts.  During active testing, you may
need to increase your price tier. Once done, you should decrease the price tier to save on
your bill.

The long term goal is to use Azure Functions to run the required code. While trying to
implement this as an Azure Function, it was difficult to test.  The current code is implemented
as a Web Job with a Timer Trigger.

## Setup

1. create application in Azure Active Directory and configure authentication
2. deploy web job
3. deploy and configure configuration file. The location of the configuration file should be added in an application setting called "database-config-file".

### Authentication

The web job will need to authenticate to your subscription/resource group.  You will need an application setup 
in Azure Active Directory.  You will need to determine how you will authenticate. You can use:

* client secret - an application secret (key) generated by the management portal
* certificate - you can upload the certificate to the App Service and use the find values.

### Configuration File

```
[
  {
    "authentication": {
      "subscriptionId": "{subscription-id}",
      "tenant": "{active-directory-tenant}",
      "clientId": "{application-client-id}",
      "clientSecret": "{application-client-secret}",
      "certificate": {
        "find": {
          "type": "",
          "value":  ""  
        },
        "use": {
          "filename": "",
          "password": ""
        }
      }
    },
    "databases": [
      {
        "resourceGroup": "",
        "server": "",
        "database": "",
        "settings": [
          {
            "buffer": 120,
            "period": "01:00:00",
            "grain": "00:05:00",
            "value": "maximum",
            "minTier": "Basic",
            "maxTier": "S3"
          }
        ]
      }
    ]
  }
]
```

#### Minimal Configuration File

The configuration file is designed to have reasonable defaults. Below is a minimal configuation file.

```
[
  {
    "authentication": {
      "subscriptionId": "{subscription-id}",
      "tenant": "{active-directory-tenant}",
      "clientId": "{application-client-id}",
      "clientSecret": "{application-client-secret}"
     }
    },
    "databases": [
      {
        "resourceGroup": "",
        "server": "",
        "database": "",
        "settings": [
          {
            "minTier": "S0",
            "maxTier": "S3"
          }

      }
    ]
  }
]
```

The settings is an array to allow additional entries for different times of day or days of week. You may want different limits off hours vs prime time hours.  This is a future enhancement.

* **server** - the name of the database server. Not the FQDN, ie do not include '.database.windows.net'.

settings

* **period** - the time range in the past to view usage. Defaults to 01:00:00 (one hour).
* **grain** - the granularity of the metrics in multiples of 5 minutes.
* **buffer** - a percentage of the *value* to determine the target DTU level. 120 would give 20% higher target value based on the history.
* **value** - *maximum* or *average* metric to use. Defaults to *maximum*.
* **minTier** - the minimum price tier to use. Defaults to the lowest price tier based database edition (Basic,Standard,Premium)
* **maxTier** - the maximum price tier to use. Defaults to the highest price tier based database edition (Basic,Standard,Premium)